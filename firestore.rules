rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper: is the user signed in?
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper: is the user an Admin?
    function isAdmin() {
      return isSignedIn() && (
        request.auth.token.email == "frank.p.6@gmail.com" || 
        request.auth.token.email == "montapulse@gmail.com" ||
        request.auth.token.email == "fhernandezcalle@gmail.com" ||
        request.auth.token.email == "pruebasyaprendizaje0@gmail.com"
      );
    }

    // Users: Only owner or admin can read/write
    match /users_v2/{userId} {
      allow read, write: if (isSignedIn() && request.auth.uid == userId) || isAdmin();
    }

    // Events: Public read, authenticated write
    match /events/{eventId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    // Businesses: Public read, authenticated write
    match /businesses/{bizId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    // Favorites: Only owner can manage their favorites
    match /favorites/{favId} {
      allow read, write: if isSignedIn() && (
        request.auth.uid == request.resource.data.userId || 
        (resource != null && request.auth.uid == resource.data.userId)
      );
    }

    // Settings: Public read, Admin only write
    match /settings/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Default deny
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
